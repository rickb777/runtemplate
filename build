#!/bin/bash -e
cd $(dirname $0)
D=$PWD

PATH=$HOME/go/bin:$PATH
export GOPATH=$HOME/go
export GO111MODULE=off

mkdir -p $GOPATH

if [ ! -d $GOPATH/src/github.com/johanbrandhorst/runtemplate ]; then
  cd $GOPATH
  mkdir -p src/github.com/johanbrandhorst
  cd       src/github.com/johanbrandhorst
  ln -vs $D .
  cd $D
fi

go get -x github.com/go-playground/statics/static
go get -x github.com/benmoss/matchers
go get -x golang.org/x/net/html/charset

./builtintest/clean

./copy-threadsafe-builtins

./get-statics-tool

go generate .

echo -e "// git: \"$(git describe --tags 2>/dev/null)\"" >> app/statics.go
fgrep const version.go >> app/statics.go

echo
echo App Testing...
go test ./app/...

echo
echo Installing...
cd $GOPATH
go install github.com/johanbrandhorst/runtemplate
cd $D

type runtemplate

builtin/info ||:

echo
echo Generating tests...
go generate -v ./builtintest/...

rm -f examples/*_*.go
go generate ./examples

gofmt -l -w examples/*.go

echo
echo Template Testing...
RACE=
[ "$CGO_ENABLED" != "1" ] || RACE=-race
go test $RACE ./app/... ./builtintest/...

echo
echo Code vetting...
go vet . ./app/... ./builtintest/... ./examples/...

echo ok.
